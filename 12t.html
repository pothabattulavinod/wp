<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- JWPlayer -->
  <script src="https://ssl.p.jwpcdn.com/player/v/8.32.0/jwplayer.js"></script>
  
  <!-- hls.js -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  
  <script>
    jwplayer.key = 'cLGMn8T20tGvW+0eXPhq4NNmLB57TrscPjd1IyJF84o=';
  </script>

  <style>
    body { margin: 0; overflow: hidden; }
    #player { width: 100%; height: 100%; background: #000; }
  </style>
</head>
<body>
  <div id="player"></div>

  <script>
    // --- Fetch signed URL from Worker ---
    async function getSignedUrl(videoPath) {
      try {
        const res = await fetch(`https://m.vinodyadavpothabattula666.workers.dev/generate-signed-url?video=${videoPath}`);
        const data = await res.json();
        return data.url;
      } catch (err) {
        console.error("Failed to fetch signed URL:", err);
        return null;
      }
    }

    // --- Fetch and rewrite playlist from GitHub ---
    async function fetchAndRewritePlaylist(githubPlaylistPath) {
      const signedUrl = await getSignedUrl(githubPlaylistPath);
      if (!signedUrl) return null;

      const res = await fetch(signedUrl);
      if (!res.ok) throw new Error("Failed to fetch playlist");

      let text = await res.text();

      // Rewrite all nested .m3u8 and .ts URLs to go through Worker
      text = text.replace(/(https?:\/\/.*\.(m3u8|ts))/g, match => {
        const url = new URL(match);
        const path = "/pay/" + url.pathname.split("/").pop(); // keep filename
        return `${path}?${url.searchParams.toString()}&expires=${new URL(signedUrl).searchParams.get('expires')}&sig=${new URL(signedUrl).searchParams.get('sig')}`;
      });

      return "data:application/vnd.apple.mpegurl;base64," + btoa(text);
    }

    async function setupPlayer(videoName) {
      const playlistDataUrl = await fetchAndRewritePlaylist(`/pay/${videoName}`);
      if (!playlistDataUrl) return;

      const jwp = jwplayer('player');
      const pageUrl = window.location.href;
      const playbackKey = `jwplayer-playback-position-${pageUrl}`;
      const savedPosition = localStorage.getItem(playbackKey);

      jwp.setup({
        aspectratio: "16:9",
        width: "100%",
        height: "100%",
        sources: [{ file: playlistDataUrl, type: "hls", default: true }],
        primary: "html5",
        preload: "auto",
        hlshtml: true,
        controls: true
      });

      jwp.on('ready', () => {
        if (savedPosition && !isNaN(savedPosition)) jwp.seek(parseFloat(savedPosition));
      });

      jwp.on('time', e => localStorage.setItem(playbackKey, e.position));
      jwp.on('complete', () => localStorage.removeItem(playbackKey));
    }

    // --- Initialize player with video ---
    setupPlayer("aay/playlist.m3u8"); // GitHub folder path
  </script>
</body>
</html>
